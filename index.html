<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コーヒー物語日記</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
   
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8B4513"/>

    <!-- iOS向け（インストールUIは手動） -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <link rel="stylesheet" href="style.css">

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>☕ Daily Brew Logger</h1>
            <p class="subtitle">毎日のコーヒー抽出を記録・分析して、理想の一杯を追求しよう</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('record', event)">🚀 記録する</button>
            <button class="nav-tab" onclick="showTab('taste-chart', event)">📊 味のチャート</button>
            <button class="nav-tab" onclick="showTab('analytics', event)">📈 分析</button>
            <button class="nav-tab" onclick="showTab('history', event)">📋 履歴</button>
            <button class="nav-tab" onclick="showTab('settings', event)">⚙️ 設定</button>
        </div>

        <div id="record" class="tab-content active">
            <div class="today-summary">
                <h2>📅 今日の記録</h2>
                <p id="today-date"></p>
                <div class="summary-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="today-count">0</div>
                        <div>今日の記録数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-satisfaction">-</div>
                        <div>平均満足度</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streak-days">0</div>
                        <div>連続記録日数</div>
                    </div>
                </div>
            </div>

            <div class="quick-record-section">
                <div class="card">
                    <fieldset>
                        <legend>抽出レシピ</legend>
                        <div class="form-group">
                            <label for="brew-datetime">抽出日時</label>
                            <input type="datetime-local" id="brew-datetime" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="bean-type">豆の種類</label>
                            <select id="bean-type" class="form-control"></select>
                        </div>
                        <div class="form-group ratio-group">
                            <div>
                                <label for="bean-weight">豆の量 (g)</label>
                                <input type="number" id="bean-weight" class="form-control" placeholder="15" step="0.1">
                            </div>
                            <div>
                                <label for="brew-ratio">比率 (1:)</label>
                                <input type="number" id="brew-ratio" class="form-control" placeholder="15">
                            </div>
                            <div>
                                <label for="water-weight">お湯の量 (g)</label>
                                <input type="number" id="water-weight" class="form-control" placeholder="225">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="grind-size">挽き目</label>
                            <select id="grind-size" class="form-control">
                                <option value="粗挽き">粗挽き</option>
                                <option value="中粗挽き">中粗挽き</option>
                                <option value="中挽き">中挽き</option>
                                <option value="中細挽き" selected>中細挽き</option>
                                <option value="細挽き">細挽き</option>
                                <option value="極細挽き">極細挽き</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dripper">ドリッパー</label>
                             <select id="dripper" class="form-control">
                                <option value="V60円錐ペーパーフィルター">HARIO V60</option>
                                <option value="台形ペーパーフィルター">台形ペーパーフィルター</option>
                                <option value="ステンレスフィルター">ステンレスフィルター</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="water-temperature">湯温 (°C)</label>
                            <input type="number" id="water-temperature" class="form-control" placeholder="例: 89">
                        </div>
                        <div class="form-group">
                            <label for="extraction-method">抽出メソッド</label>
                            <select id="extraction-method" class="form-control"></select>
                        </div>
                        <button class="btn btn-secondary" onclick="startDripTimer()" id="drip-timer-btn" disabled>⏱️ ドリップタイマーを開始</button>
                    </fieldset>
                </div>

                <div class="card">
                    <fieldset>
                        <legend>今日の詳細</legend>
                        <div class="form-group">
                            <label for="theme">今日のテーマ</label>
                            <input type="text" id="theme" class="form-control" placeholder="例: フルーティーさを引き出す">
                        </div>
                         <div class="form-group">
                            <label for="summary">サマリー</label>
                            <textarea id="summary" class="form-control" rows="3" placeholder="味わいの感想、気づいたことなど"></textarea>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>テイスティングノート</legend>
                        <div class="rating-container">
                            <div class="rating-row">
                                <span class="rating-label">香り</span>
                                <div class="stars" data-rating="aroma">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div class="rating-row">
                                <span class="rating-label">酸味</span>
                                <div class="stars" data-rating="acidity">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div class="rating-row">
                                <span class="rating-label">甘さ</span>
                                <div class="stars" data-rating="sweetness">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div class="rating-row">
                                <span class="rating-label">苦み</span>
                                <div class="stars" data-rating="bitterness">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div class="rating-row">
                                <span class="rating-label">ボディ</span>
                                <div class="stars" data-rating="body">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                            <div class="rating-row">
                                <span class="rating-label">余韻</span>
                                <div class="stars" data-rating="aftertaste">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                     <fieldset>
                         <legend>総合評価</legend>
                        <div class="rating-container">
                             <div class="rating-row">
                                <span class="rating-label">総合満足度</span>
                                <div class="stars" data-rating="satisfaction">
                                    <span class="star" data-value="1">★</span><span class="star" data-value="2">★</span><span class="star" data-value="3">★</span><span class="star" data-value="4">★</span><span class="star" data-value="5">★</span>
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <div class="btn-group">
                        <input type="hidden" id="editing-record-id">
                        <button class="btn btn-secondary" onclick="loadLastRecipe()">📋 前回と同じ</button>
                        <button id="save-btn" class="btn btn-primary" onclick="handleSaveClick()">💾 記録を保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="taste-chart" class="tab-content">
            <div class="card">
                <h3>📊 豆ごとの味のチャート（レーダーチャート）</h3>
                <p>記録したコーヒーの味の特徴をレーダーチャートで視覚化します。チャートは最新の記録から順に表示されます。</p>
                <div class="form-group">
                    <label>表示する豆を選択</label>
                    <div id="taste-chart-filter-container" style="display: flex; flex-wrap: wrap; gap: 15px;">
                        </div>
                </div>
                <div id="taste-charts-container" class="taste-charts-grid">
                    <p>まだ表示できる記録がありません。</p>
                </div>
            </div>
        </div>


        <div id="analytics" class="tab-content">
            <div class="card">
                <h3>📈 満足度推移（過去30日）</h3>
                <div class="chart-container">
                    <canvas id="satisfactionChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>🌱 豆の種類別平均評価</h3>
                <div class="chart-container">
                    <canvas id="beanChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>🏆 今月のベストレシピ</h3>
                <div id="best-recipe">
                    <p>データを蓄積中...</p>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="card">
                <h3>📋 最近の記録</h3>
                <div class="history-controls">
                    <label for="sort-by">並べ替え:</label>
                    <select id="sort-by" class="form-control" onchange="coffeeLogger.updateHistoryDisplay()">
                        <option value="date">抽出日</option>
                        <option value="satisfaction">満足度</option>
                        <option value="beanType">豆の種類</option>
                        <option value="daysSinceRoast">焙煎後の経過日数</option>
                    </select>
                    <button id="sort-direction-btn" class="btn btn-secondary" onclick="coffeeLogger.toggleSortDirection()">降順</button>
                </div>
                <div class="records-list" id="records-list">
                    <p>まだ記録がありません。最初の一杯を記録してみましょう！</p>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="card">
                <h3>バックアップ / 乗り換え</h3>
                <p>Safari で貯めたデータ → PWA へ引っ越しできます。</p>
                <div class="btn-group" style="margin-top:10px">
                <button class="btn btn-secondary btn-small" onclick="coffeeLogger.exportJSON()">JSONエクスポート（ファイル）</button>
                <button class="btn btn-secondary btn-small" onclick="coffeeLogger.exportJSONToClipboard()">JSONをコピー（簡単）</button>
                <button class="btn btn-primary btn-small" onclick="showImportModal()">JSONインポート</button>
                </div>
            </div> 
            <div class="card">
                <h3>MY BEANS</h3>
                <p>お持ちのコーヒー豆を登録・管理します。</p>
                <div class="api-settings"> 
                    <input type="hidden" id="editing-bean-index">
                    <div class="modal-grid">
                        <div class="form-group">
                            <label for="new-bean-name">豆の名前</label>
                            <input type="text" id="new-bean-name" class="form-control" placeholder="例: エチオピア イルガチェフェ">
                        </div>
                        <div class="form-group">
                            <label for="bean-url">豆のURL</label>
                            <input type="url" id="bean-url" class="form-control" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="store-name">販売店</label>
                            <input type="text" id="store-name" class="form-control" placeholder="例: 〇〇コーヒー">
                        </div>
                         <div class="form-group">
                            <label for="store-url">販売店のURL</label>
                            <input type="url" id="store-url" class="form-control" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="roast-level">焙煎度</label>
                            <select id="roast-level" class="form-control">
                                <option value="ライト">ライト (Light)</option>
                                <option value="シナモン">シナモン (Cinnamon)</option>
                                <option value="ミディアム">ミディアム (Medium)</option>
                                <option value="ハイ">ハイ (High)</option>
                                <option value="シティ">シティ (City)</option>
                                <option value="フルシティ">フルシティ (Full City)</option>
                                <option value="フレンチ">フレンチ (French)</option>
                                <option value="イタリアン">イタリアン (Italian)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="roast-date">焙煎日</label>
                            <div class="roast-date-group">
                                <input type="date" id="roast-date" class="form-control">
                                <input type="checkbox" id="roast-date-unknown">
                                <label for="roast-date-unknown">不明</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="purchase-type">購入形式</label>
                            <select id="purchase-type" class="form-control">
                                <option value="豆">豆</option>
                                <option value="粉">粉</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="price">価格（円）</label>
                            <input type="number" id="price" class="form-control" placeholder="例: 1500">
                        </div>
                         <div class="form-group">
                            <label for="purchase-weight">購入量（g）</label>
                            <input type="number" id="purchase-weight" class="form-control" placeholder="例: 200">
                        </div>
                        <div class="form-group">
                            <label for="purchase-date">購入日</label>
                            <input type="date" id="purchase-date" class="form-control">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="bean-memo">豆の特徴や感じたことのメモ</label>
                            <textarea id="bean-memo" class="form-control" rows="4" placeholder="例：フローラルな香り、ベリーのような酸味と甘さ。後味はすっきりしている。"></textarea>
                        </div>
                    </div>
                    <div id="bean-form-buttons" class="btn-group">
                        <button class="btn btn-primary" onclick="addOrUpdateBean()">＋ 豆を登録</button>
                    </div>
                </div>
                
                <div id="bean-list-container" style="margin-top: 20px;">
                </div>
            </div>

            <div class="card">
                <h3>抽出メソッド</h3>
                <p>よく使う抽出手順をメソッドとして登録します。</p>
                <div class="api-settings">
                    <div class="form-group">
                        <label for="new-method-name">メソッド名</label>
                        <input type="text" id="new-method-name" class="form-control" placeholder="例: V60 2杯用">
                    </div>
                    <div id="method-steps-container">
                        </div>
                    <button class="btn btn-secondary btn-small" onclick="addMethodStep()">＋ 手順を追加</button>
                    <hr style="margin: 20px 0;">
                    <div class="form-group">
                         <label>総抽出時間</label>
                         <div class="time-input-group">
                             <input type="number" id="method-total-time-min" class="form-control" placeholder="分" min="0">
                             <span>:</span>
                             <input type="number" id="method-total-time-sec" class="form-control" placeholder="秒" min="0" max="59">
                         </div>
                     </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveMethod()">メソッドを保存</button>
                    </div>
                </div>
                <div id="method-list-container" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <div id="generic-modal" class="modal">
        <div class="modal-content" id="modal-content-slot">
            </div>
    </div>

    <div id="drip-timer-modal" class="modal">
        <div class="modal-content drip-timer-modal-content">
            <span class="modal-close" onclick="hideDripTimer()">&times;</span>
            <h3>ドリップタイマー</h3>
            <div id="drip-timer-display">00:00.0</div>
            <div id="drip-timer-steps"></div>
            <div class="btn-group">
                <button id="drip-timer-start-stop" class="btn btn-primary" onclick="toggleDripTimer()">スタート</button>
                <button id="drip-timer-reset" class="btn btn-secondary" onclick="resetDripTimer()">リセット</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="hideImportModal()">&times;</span>
            <h3>データをインポート</h3>
            <p>エクスポートしたデータを下の欄に貼り付けてください。</p>
            <div class="form-group">
                <textarea id="import-data-area" class="form-control" rows="8" placeholder="ここにデータを貼り付け..."></textarea>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="importData()">インポートを実行</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>
